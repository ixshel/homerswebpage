name: Notify MS Teams on PR Merge

on:
  pull_request:
    types:
      - closed

jobs:
  notify-teams:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Set Tier Label Based on Branch
        run: |
          if [[ "${{ github.event.pull_request.base.ref }}" == "main" ]]; then
            echo "TIER=🚀 **Production (Main)**" >> $GITHUB_ENV
          elif [[ "${{ github.event.pull_request.base.ref }}" == "staging" ]]; then
            echo "TIER=🛠️ **Staging**" >> $GITHUB_ENV
          elif [[ "${{ github.event.pull_request.base.ref }}" == "develop" ]]; then
            echo "TIER=🔧 **Development**" >> $GITHUB_ENV
          else
            echo "TIER=Unknown Environment" >> $GITHUB_ENV
          fi

      - name: Send Notification to MS Teams
        run: |
          curl -H "Content-Type: application/json" -X POST -d "$(jq -n \
            --arg tier "$TIER" \
            --arg repo "${{ github.repository }}" \
            --arg title "${{ github.event.pull_request.title }}" \
            --arg mergedBy "${{ github.event.pull_request.merged_by.login }}" \
            --arg prLink "${{ github.event.pull_request.html_url }}" \
            '{text: "✅ A pull request has been merged!\n\n🔹 **Environment:** \($tier)\n🔹 **Repository:** \($repo)\n🔹 **PR Title:** \($title)\n🔹 **Merged By:** \($mergedBy)\n🔹 **PR Link:** \($prLink)"}' \
          )" ${{ secrets.TEAMS_WEBHOOK_MAIN }}
